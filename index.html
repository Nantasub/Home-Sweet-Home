<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมจัดการการซื้อบ้าน (Home Buying Manager)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            scroll-behavior: smooth;
            background: linear-gradient(to top left, #fbc2eb 0%, #a6c1ee 100%);
            min-height: 100vh;
        }
        .tab-active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .tabs-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .tabs-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        .form-input {
            @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto max-w-4xl p-4">
        <!-- Header -->
        <header class="bg-white/70 backdrop-blur-sm rounded-xl shadow-md p-6 mb-6 text-center">
            <h1 class="text-4xl font-bold text-gray-700">Home Sweet Home</h1>
        </header>

        <!-- Tabs -->
        <div class="mb-6">
            <div class="border-b border-gray-200 bg-white rounded-t-lg shadow-sm">
                <nav class="tabs-container -mb-px flex space-x-2 overflow-x-auto p-2" aria-label="Tabs">
                    <button onclick="changeTab('activity')" class="tab tab-active shrink-0 py-3 px-4 border-b-2 font-medium text-sm rounded-md">ภาพรวม (Activity)</button>
                    <button onclick="changeTab('summary')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">สรุปค่าใช้จ่าย</button>
                    <button onclick="changeTab('builtin')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">Built-in</button>
                    <button onclick="changeTab('appliances')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">เครื่องใช้ไฟฟ้า</button>
                    <button onclick="changeTab('furniture')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">เฟอร์นิเจอร์</button>
                    <button onclick="changeTab('projectLegalities')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">นิติกรรมโครงการ</button>
                    <button onclick="changeTab('bankLegalities')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">นิติกรรมธนาคาร</button>
                    <button onclick="changeTab('homeInspection')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">ตรวจรับบ้าน</button>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <main id="mainContent">
            <!-- Content for each tab will be rendered here by JavaScript -->
        </main>
    </div>

    <!-- MODALS -->
    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/3 transform -translate-y-10">
            <h3 class="text-xl font-semibold mb-4">เพิ่ม/แก้ไข นัดหมาย</h3>
            <form id="appointmentForm" class="space-y-4">
                <input type="hidden" id="appointmentId">
                <div>
                    <label for="appointmentTitle" class="form-label">รายการนัดหมาย</label>
                    <input id="appointmentTitle" type="text" class="form-input" placeholder="เช่น นัดตรวจบ้านรอบ 2" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="appointmentDate" class="form-label">วันที่</label>
                        <input id="appointmentDate" type="date" class="form-input" required>
                    </div>
                    <div>
                        <label for="appointmentTime" class="form-label">เวลา</label>
                        <input id="appointmentTime" type="time" class="form-input" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('appointmentModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Budget Item Modal -->
    <div id="budgetItemModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/3 transform -translate-y-10">
            <h3 id="budgetItemModalTitle" class="text-xl font-semibold mb-4">เพิ่มรายการ</h3>
            <form id="budgetItemForm" class="space-y-4">
                <input type="hidden" id="budgetItemId">
                 <div>
                    <label for="budgetItemName" class="form-label">ชื่อรายการ</label>
                    <input id="budgetItemName" type="text" class="form-input" placeholder="เช่น โซฟา" required>
                </div>
                 <div>
                    <label for="budgetItemCost" class="form-label">ราคา (บาท)</label>
                    <input id="budgetItemCost" type="number" step="0.01" class="form-input" placeholder="25000" required>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('budgetItemModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Home Inspection Modal -->
    <div id="inspectionModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/2 transform -translate-y-10">
            <h3 class="text-xl font-semibold mb-4">เพิ่มรายการตรวจรับบ้าน</h3>
            <form id="inspectionForm" class="space-y-4">
                 <div>
                    <label for="inspectionRound" class="form-label">การตรวจครั้งที่</label>
                    <input id="inspectionRound" type="text" class="form-input" placeholder="เช่น 1, 2, แก้ไขครั้งที่ 1" required>
                </div>
                 <div>
                    <label for="inspectionDetails" class="form-label">รายการที่ต้องแก้ไข (พิมพ์ 1 รายการต่อ 1 บรรทัด)</label>
                    <textarea id="inspectionDetails" rows="8" class="form-input" placeholder="- สีผนังไม่เรียบ\n- ปลั๊กไฟใช้งานไม่ได้"></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('inspectionModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Note Modal -->
    <div id="noteModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/3 transform -translate-y-10">
            <h3 class="text-xl font-semibold mb-4">เพิ่ม/แก้ไข ข้อมูล</h3>
            <form id="noteForm" class="space-y-4">
                <input type="hidden" id="noteId">
                <div>
                    <label for="noteText" class="form-label">รายละเอียด</label>
                    <textarea id="noteText" rows="6" class="form-input" placeholder="บันทึกข้อมูลเพิ่มเติม..."></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('noteModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DATA & STATE MANAGEMENT ---
        let currentTab = 'activity';
        let currentModal = {
            category: null,
            list: null, // 'wishlist' or 'purchased'
            itemId: null,
            sourceTab: null,
        };
        let chartInstances = {};

        const TAB_CONFIG = {
            'activity': { title: 'ภาพรวม', type: 'activity' },
            'summary': { title: 'สรุปค่าใช้จ่าย', type: 'summary' },
            'builtin': { title: 'Built-in', type: 'budget' },
            'appliances': { title: 'เครื่องใช้ไฟฟ้า', type: 'budget' },
            'furniture': { title: 'เฟอร์นิเจอร์', type: 'budget' },
            'projectLegalities': { title: 'นิติกรรมโครงการ', type: 'project' },
            'bankLegalities': { title: 'นิติกรรมธนาคาร', type: 'bank' },
            'homeInspection': { title: 'ตรวจรับบ้าน', type: 'inspection' },
        };

        const initialData = {
            appointments: [],
            bankInfo: {
                loanHouse: 0, loanDecor: 0, interest1: 0, interest2: 0, interest3: 0, interest4: 0, withInsurance: 0, monthlyPayment: 0,
            },
            projectInfo: { commonFee: 0 },
            summaryInfo: { additionalBudget: 0 },
            homeInspections: [],
            budgets: {
                builtin: { wishlist: [], purchased: [] },
                appliances: { wishlist: [], purchased: [] },
                furniture: { wishlist: [], purchased: [] },
            },
            notes: {
                projectLegalities: [],
                bankLegalities: [],
                homeInspection: [],
            },
            files: {
                builtin: [],
                appliances: [],
                furniture: [],
                projectLegalities: [],
                bankLegalities: [],
                homeInspection: [],
            }
        };

        let AppState = JSON.parse(localStorage.getItem('homeManagerAppState_v4')) || initialData;

        const saveState = () => {
            localStorage.setItem('homeManagerAppState_v4', JSON.stringify(AppState));
        };
        
        // --- IndexedDB File Storage ---
        const DB_NAME = 'HomeSweetHomeDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'files';
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => reject("IndexedDB error: " + request.errorCode);
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        function saveFile(id, file) {
            return new Promise((resolve, reject) => {
                if (!db) return reject("Database not initialized.");
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put({ id: id, file: file });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getFile(id) {
            return new Promise((resolve, reject) => {
                 if (!db) return reject("Database not initialized.");
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result.file);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteFile(id) {
            return new Promise((resolve, reject) => {
                 if (!db) return reject("Database not initialized.");
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // --- HELPER FUNCTIONS ---
        const formatCurrency = (num) => (num || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const getThaiDate = (dateString) => new Date(dateString).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'});

        // --- TEMPLATE GENERATION ---
        const mainContentEl = document.getElementById('mainContent');

        function renderContentForTab(tabId) {
            currentTab = tabId;
            const config = TAB_CONFIG[tabId];
            let content = '';

            // Destroy previous charts
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            switch(config.type) {
                case 'activity': content = createActivityTemplate(); break;
                case 'summary': content = createSummaryTemplate(); break;
                case 'budget': content = createBudgetTemplate(tabId); break;
                case 'project': content = createProjectLegalitiesTemplate(); break;
                case 'bank': content = createBankLegalitiesTemplate(); break;
                case 'inspection': content = createHomeInspectionTemplate(); break;
            }
            mainContentEl.innerHTML = content;

            // Re-initialize charts if needed
            if (config.type === 'activity') createCharts('activityChartPlanned', 'activityChartActual');
            if (config.type === 'summary') createCharts('summaryChartPlanned', 'summaryChartActual');
        }

        function createActivityTemplate() {
            const sortedAppointments = [...AppState.appointments]
                .sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time))
                .filter(a => new Date(a.date) >= new Date(new Date().setDate(new Date().getDate() - 1))); // Show today onwards
            
            const appointmentsHtml = sortedAppointments.length === 0
                ? `<p class="text-center text-gray-500 py-4">ไม่มีนัดหมายเร็วๆ นี้</p>`
                : sortedAppointments.map(appt => `
                    <div class="bg-gray-50 rounded-lg p-3 flex items-center space-x-4">
                        <div class="flex-shrink-0 bg-blue-500 text-white rounded-md p-2 text-center w-16">
                            <p class="text-xl font-bold">${new Date(appt.date).getDate()}</p>
                            <p class="text-xs">${new Date(appt.date).toLocaleDateString('th-TH', { month: 'short' })}</p>
                        </div>
                        <div>
                            <p class="font-semibold">${appt.title}</p>
                            <p class="text-sm text-gray-600">${getThaiDate(appt.date)} - ${appt.time}</p>
                            <p class="text-xs text-gray-400">จาก: ${TAB_CONFIG[appt.sourceTab]?.title}</p>
                        </div>
                    </div>`).join('');

            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-md p-6">
                         <h2 class="text-2xl font-semibold mb-4">นัดหมายที่จะถึง</h2>
                         <div class="space-y-3">${appointmentsHtml}</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-2xl font-semibold mb-4">ภาพรวมค่าใช้จ่าย</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div><canvas id="activityChartPlanned"></canvas></div>
                            <div><canvas id="activityChartActual"></canvas></div>
                        </div>
                    </div>
                </div>`;
        }

        function createSummaryTemplate() {
            const budgetData = calculateBudgets();
            
            return `
                <div class="bg-white rounded-xl shadow-md p-6 space-y-8">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4">สรุปงบประมาณ</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="bg-green-50 p-4 rounded-lg">
                                <p class="form-label">งบเงินกู้ (ตกแต่ง)</p>
                                <p class="text-2xl font-bold text-green-700">${formatCurrency(AppState.bankInfo.loanDecor)}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <label for="additionalBudget" class="form-label">งบเพิ่มเติม</label>
                                <input type="number" id="additionalBudget" onchange="updateSummaryInfo('additionalBudget', this.value)" class="form-input text-2xl font-bold text-green-700 bg-transparent border-0 p-0" value="${AppState.summaryInfo.additionalBudget || ''}" placeholder="0.00">
                            </div>
                            <div class="bg-blue-100 p-4 rounded-lg">
                                <p class="form-label">งบประมาณทั้งหมด</p>
                                <p class="text-2xl font-bold text-blue-700">${formatCurrency(budgetData.totalAvailable)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <hr/>

                    <div>
                        <h2 class="text-2xl font-semibold mb-4">สรุปค่าใช้จ่าย</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                           <!-- Planned Costs -->
                           <div class="space-y-3">
                                <h3 class="text-lg font-semibold">งบที่คาดว่าจะใช้ (Wishlist)</h3>
                                <div class="bg-orange-50 p-4 rounded-lg flex justify-between items-center">
                                    <span class="font-bold">รวมทั้งหมด</span>
                                    <span class="text-xl font-bold text-orange-700">${formatCurrency(budgetData.totalPlanned)}</span>
                                </div>
                                ${Object.keys(AppState.budgets).map(cat => `
                                <div class="p-3 rounded-lg flex justify-between items-center bg-gray-50">
                                    <span>${TAB_CONFIG[cat].title}</span>
                                    <span class="font-semibold">${formatCurrency(budgetData.planned[cat])}</span>
                                </div>
                                `).join('')}
                           </div>
                           <!-- Actual Costs -->
                           <div class="space-y-3">
                                <h3 class="text-lg font-semibold">งบที่ใช้ไปแล้ว (Purchased)</h3>
                                <div class="bg-red-50 p-4 rounded-lg flex justify-between items-center">
                                    <span class="font-bold">รวมทั้งหมด</span>
                                    <span class="text-xl font-bold text-red-700">${formatCurrency(budgetData.totalActual)}</span>
                                </div>
                                ${Object.keys(AppState.budgets).map(cat => `
                                <div class="p-3 rounded-lg flex justify-between items-center bg-gray-50">
                                    <span>${TAB_CONFIG[cat].title}</span>
                                    <span class="font-semibold">${formatCurrency(budgetData.actual[cat])}</span>
                                </div>
                                `).join('')}
                           </div>
                        </div>
                    </div>

                     <hr/>

                    <div>
                        <h2 class="text-2xl font-semibold mb-4">กราฟสรุป</h2>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div><canvas id="summaryChartPlanned"></canvas></div>
                            <div><canvas id="summaryChartActual"></canvas></div>
                        </div>
                    </div>
                </div>`;
        }
        
        function createBudgetTemplate(category) {
            const data = AppState.budgets[category];
            const renderList = (listType, items) => {
                if (items.length === 0) return `<div class="text-center text-gray-500 py-4 border rounded-lg">ไม่มีรายการ</div>`;
                return items.map(item => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p>${item.name}</p>
                            <p class="text-sm text-gray-600">${formatCurrency(item.price)} บาท</p>
                        </div>
                        <div class="flex items-center space-x-2">
                           ${listType === 'wishlist' ? `<button onclick="moveBudgetItem('${category}', ${item.id})" class="text-green-500 hover:text-green-700 p-2"><i class="fas fa-check"></i></button>` : ''}
                           <button onclick="openBudgetItemModal('${category}', '${listType}', ${item.id})" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pen"></i></button>
                           <button onclick="deleteBudgetItem('${category}', '${listType}', ${item.id})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            };

            return `
                <div class="bg-white rounded-xl shadow-md p-6 space-y-6">
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">รายการที่อยากได้ (Wishlist)</h3>
                            <button onclick="openBudgetItemModal('${category}', 'wishlist')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm font-semibold">+ เพิ่ม</button>
                        </div>
                        <div class="space-y-2">${renderList('wishlist', data.wishlist)}</div>
                    </div>
                    <hr/>
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">รายการที่ซื้อแล้ว</h3>
                            <button onclick="openBudgetItemModal('${category}', 'purchased')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm font-semibold">+ เพิ่ม</button>
                        </div>
                        <div class="space-y-2">${renderList('purchased', data.purchased)}</div>
                    </div>
                    <hr/>
                    ${createFileAttachmentTemplate(category)}
                </div>`;
        }
        
        function createInfoTemplate(tabId) {
            const appointments = AppState.appointments.filter(a => a.sourceTab === tabId);
            const appointmentsHtml = appointments.length === 0
                ? `<p class="text-gray-500 text-sm">ไม่มีนัดหมาย</p>`
                : appointments.map(a => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-semibold">${a.title}</p>
                            <p class="text-sm text-gray-600">${getThaiDate(a.date)} - ${a.time}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                           <button onclick="openAppointmentModal('${tabId}', ${a.id})" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pen"></i></button>
                           <button onclick="deleteAppointment(${a.id})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('');
            
            const notes = AppState.notes[tabId] || [];
            const notesHtml = notes.length === 0
                ? `<p class="text-gray-500 text-sm">ไม่มีข้อมูลเพิ่มเติม</p>`
                : notes.map(n => `
                    <div class="flex justify-between items-start p-3 bg-gray-50 rounded-lg">
                        <p class="text-gray-700 whitespace-pre-wrap flex-1">${n.text}</p>
                        <div class="flex items-center space-x-2 ml-2">
                           <button onclick="openNoteModal('${tabId}', ${n.id})" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pen"></i></button>
                           <button onclick="deleteNote('${tabId}', ${n.id})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('');
            
            return { appointmentsHtml, notesHtml };
        }

        function createActionButtonsTemplate(tabId) {
            return `
                <div class="flex flex-wrap gap-4">
                    <button onclick="openAppointmentModal('${tabId}')" class="flex-grow sm:flex-grow-0 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center space-x-2">
                       <i class="fas fa-calendar-plus"></i> <span>เพิ่มนัดหมาย</span>
                    </button>
                    <button onclick="openNoteModal('${tabId}')" class="flex-grow sm:flex-grow-0 bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 flex items-center justify-center space-x-2">
                       <i class="fas fa-file-alt"></i> <span>เพิ่มข้อมูล</span>
                    </button>
                </div>`;
        }
        
        function createFileAttachmentTemplate(tabId) {
            const files = AppState.files[tabId] || [];
            const filesHtml = files.length === 0
                ? `<p class="text-gray-500 text-sm text-center py-2">ไม่มีไฟล์แนบ</p>`
                : files.map(file => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3 truncate">
                            <i class="fas fa-file-pdf text-red-500"></i>
                            <span class="truncate" title="${file.name}">${file.name}</span>
                        </div>
                        <div class="flex items-center space-x-2 shrink-0">
                           <button onclick="downloadAttachedFile(${file.id}, '${file.name.replace(/'/g, "\\'")}')" class="text-green-500 hover:text-green-700 p-2"><i class="fas fa-download"></i></button>
                           <button onclick="deleteAttachedFile('${tabId}', ${file.id})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('');

            return `
                <div>
                    <h3 class="text-xl font-semibold mb-3">ไฟล์แนบ (PDF)</h3>
                    <div class="space-y-2 mb-4">${filesHtml}</div>
                    <div class="mt-2">
                        <label for="file-upload-${tabId}" class="w-full cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg inline-flex items-center justify-center">
                            <i class="fas fa-upload mr-2"></i>
                            <span>เลือกไฟล์ PDF เพื่ออัปโหลด...</span>
                        </label>
                        <input id="file-upload-${tabId}" type="file" class="hidden" accept=".pdf" onchange="handleFileUpload(event, '${tabId}')"/>
                    </div>
                </div>
            `;
        }

        function createProjectLegalitiesTemplate() {
            const { commonFee } = AppState.projectInfo;
            const { appointmentsHtml, notesHtml } = createInfoTemplate('projectLegalities');
            return `
                <div class="bg-white rounded-xl shadow-md p-6 space-y-6">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4">ข้อมูลนิติกรรมโครงการ</h2>
                        <div class="max-w-sm">
                            <label for="commonFee" class="form-label">ค่าส่วนกลาง (บาท/เดือน)</label>
                            <input type="number" id="commonFee" class="form-input" value="${commonFee || ''}" onchange="updateProjectInfo('commonFee', this.value)" placeholder="2000">
                        </div>
                    </div>
                    <hr/>
                    <div>
                        <h3 class="text-xl font-semibold mb-3">นัดหมาย</h3>
                        <div class="space-y-2">${appointmentsHtml}</div>
                    </div>
                    <hr/>
                    <div>
                        <h3 class="text-xl font-semibold mb-3">ข้อมูลเพิ่มเติม</h3>
                        <div class="space-y-2">${notesHtml}</div>
                    </div>
                    <hr/>
                    ${createFileAttachmentTemplate('projectLegalities')}
                    <hr/>
                    ${createActionButtonsTemplate('projectLegalities')}
                </div>`;
        }
        
        function createBankLegalitiesTemplate() {
            const { loanHouse, loanDecor, interest1, interest2, interest3, interest4, withInsurance, monthlyPayment } = AppState.bankInfo;
            const { appointmentsHtml, notesHtml } = createInfoTemplate('bankLegalities');
            return `
                <div class="bg-white rounded-xl shadow-md p-6 space-y-6">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4">ข้อมูลสินเชื่อ</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div><label for="loanHouse" class="form-label">วงเงินกู้ (ค่าบ้าน)</label><input type="number" id="loanHouse" onchange="updateBankInfo('loanHouse', this.value)" value="${loanHouse || ''}" class="form-input" placeholder="3000000"></div>
                             <div><label for="loanDecor" class="form-label">วงเงินกู้ (ตกแต่ง)</label><input type="number" id="loanDecor" onchange="updateBankInfo('loanDecor', this.value)" value="${loanDecor || ''}" class="form-input" placeholder="500000"></div>
                             <div><label for="interest1" class="form-label">ดอกเบี้ยปีที่ 1 (%)</label><input type="number" step="0.01" id="interest1" onchange="updateBankInfo('interest1', this.value)" value="${interest1 || ''}" class="form-input" placeholder="2.5"></div>
                             <div><label for="interest2" class="form-label">ดอกเบี้ยปีที่ 2 (%)</label><input type="number" step="0.01" id="interest2" onchange="updateBankInfo('interest2', this.value)" value="${interest2 || ''}" class="form-input" placeholder="3.5"></div>
                             <div><label for="interest3" class="form-label">ดอกเบี้ยปีที่ 3 (%)</label><input type="number" step="0.01" id="interest3" onchange="updateBankInfo('interest3', this.value)" value="${interest3 || ''}" class="form-input" placeholder="4.5"></div>
                             <div><label for="interest4" class="form-label">ดอกเบี้ยปีที่ 4+ (%)</label><input type="number" step="0.01" id="interest4" onchange="updateBankInfo('interest4', this.value)" value="${interest4 || ''}" class="form-input" placeholder="5.5"></div>
                             <div><label for="withInsurance" class="form-label">วงเงินรวมประกัน</label><input type="number" id="withInsurance" onchange="updateBankInfo('withInsurance', this.value)" value="${withInsurance || ''}" class="form-input" placeholder="3600000"></div>
                             <div><label for="monthlyPayment" class="form-label">ยอดผ่อน/เดือน</label><input type="number" id="monthlyPayment" onchange="updateBankInfo('monthlyPayment', this.value)" value="${monthlyPayment || ''}" class="form-input" placeholder="18000"></div>
                        </div>
                    </div>
                    <hr/>
                    <div>
                        <h3 class="text-xl font-semibold mb-3">นัดหมาย</h3>
                        <div class="space-y-2">${appointmentsHtml}</div>
                    </div>
                    <hr/>
                    <div>
                        <h3 class="text-xl font-semibold mb-3">ข้อมูลเพิ่มเติม</h3>
                        <div class="space-y-2">${notesHtml}</div>
                    </div>
                    <hr/>
                    ${createFileAttachmentTemplate('bankLegalities')}
                    <hr/>
                    ${createActionButtonsTemplate('bankLegalities')}
                </div>`;
        }

        function createHomeInspectionTemplate() {
            const inspectionsHtml = AppState.homeInspections.length === 0
                ? `<p class="text-center text-gray-500 py-4">ยังไม่มีรายการตรวจ</p>`
                : AppState.homeInspections.map(insp => `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-lg">การตรวจครั้งที่ ${insp.round}</h4>
                            <button onclick="deleteInspection(${insp.id})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                        <ul class="list-disc pl-5 space-y-1 text-gray-700 whitespace-pre-wrap">${insp.details.split('\n').filter(line => line.trim() !== '').map(line => `<li>${line}</li>`).join('')}</ul>
                    </div>`).join('');
            
            const { appointmentsHtml, notesHtml } = createInfoTemplate('homeInspection');

            return `
                <div class="bg-white rounded-xl shadow-md p-6 space-y-6">
                    <div>
                        <h2 class="text-2xl font-semibold">รายการตรวจรับบ้าน</h2>
                    </div>
                    <div class="space-y-4">${inspectionsHtml}</div>
                    <hr/>
                    <div>
                        <h3 class="text-xl font-semibold mb-3">นัดหมาย</h3>
                        <div class="space-y-2">${appointmentsHtml}</div>
                    </div>
                    <hr/>
                    <div>
                        <h3 class="text-xl font-semibold mb-3">ข้อมูลเพิ่มเติม</h3>
                        <div class="space-y-2">${notesHtml}</div>
                    </div>
                    <hr/>
                    ${createFileAttachmentTemplate('homeInspection')}
                    <hr/>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="openInspectionModal()" class="flex-grow sm:flex-grow-0 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center justify-center space-x-2">
                           <i class="fas fa-plus"></i> <span>เพิ่มรายการตรวจ</span>
                        </button>
                        ${createActionButtonsTemplate('homeInspection').replace('<div class="flex flex-wrap gap-4">','').replace('</div>','')}
                    </div>
                </div>`;
        }

        // --- CHARTING ---
        function calculateBudgets() {
            const result = {
                planned: {},
                actual: {},
                totalPlanned: 0,
                totalActual: 0,
                totalAvailable: (AppState.bankInfo.loanDecor || 0) + (AppState.summaryInfo.additionalBudget || 0),
            };
            for (const cat in AppState.budgets) {
                result.planned[cat] = AppState.budgets[cat].wishlist.reduce((sum, item) => sum + item.price, 0);
                result.actual[cat] = AppState.budgets[cat].purchased.reduce((sum, item) => sum + item.price, 0);
                result.totalPlanned += result.planned[cat];
                result.totalActual += result.actual[cat];
            }
            return result;
        }

        function createCharts(plannedCanvasId, actualCanvasId) {
            const budgetData = calculateBudgets();
            const categories = Object.keys(AppState.budgets);
            const labels = categories.map(c => TAB_CONFIG[c].title);
            const colors = ['#34d399', '#fbbf24', '#60a5fa'];
            
            const plannedRemaining = Math.max(0, budgetData.totalAvailable - budgetData.totalPlanned);
            const actualRemaining = Math.max(0, budgetData.totalAvailable - budgetData.totalActual);

            // Planned Chart
            const plannedCtx = document.getElementById(plannedCanvasId)?.getContext('2d');
            if(plannedCtx) {
                chartInstances.planned = new Chart(plannedCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [...labels, 'งบประมาณคงเหลือ'],
                        datasets: [{
                            data: [...categories.map(c => budgetData.planned[c]), plannedRemaining],
                            backgroundColor: [...colors, '#e5e7eb'],
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: `งบที่คาดว่าจะใช้ (รวม ${formatCurrency(budgetData.totalPlanned)})` } } }
                });
            }

            // Actual Chart
            const actualCtx = document.getElementById(actualCanvasId)?.getContext('2d');
            if(actualCtx) {
                chartInstances.actual = new Chart(actualCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [...labels, 'งบประมาณคงเหลือ'],
                        datasets: [{
                            data: [...categories.map(c => budgetData.actual[c]), actualRemaining],
                            backgroundColor: [...colors, '#e5e7eb'],
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: `งบที่ใช้ไปแล้ว (รวม ${formatCurrency(budgetData.totalActual)})` } } }
                });
            }
        }
        
        // --- LOGIC & EVENT HANDLERS ---
        const changeTab = (tabId) => {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('tab-active'));
            document.querySelector(`button[onclick="changeTab('${tabId}')"]`).classList.add('tab-active');
            renderContentForTab(tabId);
        };

        // Bank/Project/Summary Info
        const updateBankInfo = (key, value) => { AppState.bankInfo[key] = parseFloat(value) || 0; saveState(); };
        const updateProjectInfo = (key, value) => { AppState.projectInfo[key] = parseFloat(value) || 0; saveState(); };
        const updateSummaryInfo = (key, value) => { AppState.summaryInfo[key] = parseFloat(value) || 0; saveState(); renderContentForTab('summary'); };

        // Home Inspection Logic
        const openInspectionModal = () => {
            document.getElementById('inspectionForm').reset();
            openModal('inspectionModal');
        };
        document.getElementById('inspectionForm').addEventListener('submit', e => {
            e.preventDefault();
            AppState.homeInspections.push({
                id: Date.now(),
                round: document.getElementById('inspectionRound').value,
                details: document.getElementById('inspectionDetails').value,
            });
            saveState();
            renderContentForTab('homeInspection');
            closeModal('inspectionModal');
        });
        const deleteInspection = (id) => {
            AppState.homeInspections = AppState.homeInspections.filter(i => i.id !== id);
            saveState();
            renderContentForTab('homeInspection');
        };
        
        // Budget Item Logic
        const openBudgetItemModal = (category, list, itemId = null) => {
            currentModal = { category, list, itemId };
            const form = document.getElementById('budgetItemForm');
            form.reset();
            document.getElementById('budgetItemId').value = '';
            
            const titleAction = itemId ? 'แก้ไข' : 'เพิ่ม';
            document.getElementById('budgetItemModalTitle').innerText = `${titleAction}รายการ: ${TAB_CONFIG[category].title}`;

            if(itemId) {
                const item = AppState.budgets[category][list].find(i => i.id === itemId);
                if(item) {
                    document.getElementById('budgetItemId').value = item.id;
                    document.getElementById('budgetItemName').value = item.name;
                    document.getElementById('budgetItemCost').value = item.price;
                }
            }
            openModal('budgetItemModal');
        };

        document.getElementById('budgetItemForm').addEventListener('submit', e => {
            e.preventDefault();
            const { category, list } = currentModal;
            const id = parseInt(document.getElementById('budgetItemId').value);
            const name = document.getElementById('budgetItemName').value;
            const price = parseFloat(document.getElementById('budgetItemCost').value);

            if(id) { // Edit
                const itemIndex = AppState.budgets[category][list].findIndex(i => i.id === id);
                if(itemIndex > -1) AppState.budgets[category][list][itemIndex] = { id, name, price };
            } else { // Add
                AppState.budgets[category][list].push({ id: Date.now(), name, price });
            }
            saveState();
            renderContentForTab(category);
            closeModal('budgetItemModal');
        });
        
        const deleteBudgetItem = (category, list, itemId) => {
            AppState.budgets[category][list] = AppState.budgets[category][list].filter(i => i.id !== itemId);
            saveState();
            renderContentForTab(category);
        };
        
        const moveBudgetItem = (category, itemId) => {
            const itemIndex = AppState.budgets[category].wishlist.findIndex(i => i.id === itemId);
            if(itemIndex > -1) {
                const [item] = AppState.budgets[category].wishlist.splice(itemIndex, 1);
                AppState.budgets[category].purchased.push(item);
                saveState();
                renderContentForTab(category);
            }
        };

        // Appointment Logic
        const openAppointmentModal = (sourceTab, appointmentId = null) => {
            currentModal = { sourceTab, itemId: appointmentId };
            const form = document.getElementById('appointmentForm');
            form.reset();
            document.getElementById('appointmentId').value = '';

            if (appointmentId) {
                const appt = AppState.appointments.find(a => a.id === appointmentId);
                if (appt) {
                    document.getElementById('appointmentId').value = appt.id;
                    document.getElementById('appointmentTitle').value = appt.title;
                    document.getElementById('appointmentDate').value = appt.date;
                    document.getElementById('appointmentTime').value = appt.time;
                }
            }
            openModal('appointmentModal');
        };

        document.getElementById('appointmentForm').addEventListener('submit', e => {
            e.preventDefault();
            const id = parseInt(document.getElementById('appointmentId').value);
            const apptData = {
                title: document.getElementById('appointmentTitle').value,
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                sourceTab: currentModal.sourceTab,
            };

            if (id) { // Edit
                const apptIndex = AppState.appointments.findIndex(a => a.id === id);
                if (apptIndex > -1) AppState.appointments[apptIndex] = { ...AppState.appointments[apptIndex], ...apptData };
            } else { // Add
                AppState.appointments.push({ ...apptData, id: Date.now() });
            }
            
            saveState();
            closeModal('appointmentModal');
            renderContentForTab(currentTab);
        });

        const deleteAppointment = (id) => {
            AppState.appointments = AppState.appointments.filter(a => a.id !== id);
            saveState();
            renderContentForTab(currentTab);
        };
        
        // Note Logic
        const openNoteModal = (sourceTab, noteId = null) => {
            currentModal = { sourceTab, itemId: noteId };
            const form = document.getElementById('noteForm');
            form.reset();
            document.getElementById('noteId').value = '';

            if (noteId) {
                const note = AppState.notes[sourceTab].find(n => n.id === noteId);
                if (note) {
                    document.getElementById('noteId').value = note.id;
                    document.getElementById('noteText').value = note.text;
                }
            }
            openModal('noteModal');
        };
        
        document.getElementById('noteForm').addEventListener('submit', e => {
            e.preventDefault();
            const id = parseInt(document.getElementById('noteId').value);
            const { sourceTab } = currentModal;
            const noteData = {
                text: document.getElementById('noteText').value,
            };

            if (id) { // Edit
                 const noteIndex = AppState.notes[sourceTab].findIndex(n => n.id === id);
                 if (noteIndex > -1) AppState.notes[sourceTab][noteIndex] = { ...AppState.notes[sourceTab][noteIndex], ...noteData };
            } else { // Add
                 AppState.notes[sourceTab].push({ ...noteData, id: Date.now() });
            }

            saveState();
            closeModal('noteModal');
            renderContentForTab(sourceTab);
        });

        const deleteNote = (sourceTab, noteId) => {
            AppState.notes[sourceTab] = AppState.notes[sourceTab].filter(n => n.id !== noteId);
            saveState();
            renderContentForTab(sourceTab);
        };

        // File Logic
        async function handleFileUpload(event, tabId) {
            const file = event.target.files[0];
            if (!file) return;

            const fileData = {
                id: Date.now(),
                name: file.name
            };

            try {
                await saveFile(fileData.id, file); // Save blob to IndexedDB
                if (!AppState.files[tabId]) AppState.files[tabId] = [];
                AppState.files[tabId].push(fileData); // Save metadata to AppState
                saveState(); // Save AppState to localStorage
                renderContentForTab(tabId); // Re-render UI
            } catch (error) {
                console.error("Failed to save file:", error);
            }
        }

        async function downloadAttachedFile(fileId, fileName) {
            try {
                const file = await getFile(fileId);
                if (!file) {
                    console.error("File not found in database.");
                    return;
                }

                const url = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Failed to download file:", error);
            }
        }

        async function deleteAttachedFile(tabId, fileId) {
            try {
                await deleteFile(fileId); // Delete from IndexedDB
                AppState.files[tabId] = AppState.files[tabId].filter(f => f.id !== fileId); // Delete from AppState
                saveState(); // Save AppState
                renderContentForTab(tabId); // Re-render
            } catch (error) {
                console.error("Failed to delete file:", error);
            }
        }
        
        // --- MODAL CONTROLS ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('-translate-y-10');
            }, 10);
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('-translate-y-10');
            setTimeout(() => {
                modal.classList.add('hidden');
                currentModal = {}; // Reset modal state
            }, 250);
        }

        // --- INITIAL RENDER ---
        window.onload = async () => {
            try {
                await initDB();
            } catch (error) {
                console.error("Failed to initialize database:", error);
                // The application will still work, but file attachment will fail.
            }
            renderContentForTab('activity');
        };
    </script>
</body>
</html>

