<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Sweet Home - โปรแกรมจัดการการซื้อบ้าน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: linear-gradient(to top left, #fbc2eb 0%, #a6c1ee 100%); min-height: 100vh; }
        .tab-active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .modal { transition: opacity 0.25s ease; z-index: 50; }
        .modal-content { transition: transform 0.25s ease; }
        .tabs-container { -ms-overflow-style: none; scrollbar-width: none; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .form-input { @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm; }
        .form-label { @apply block text-sm font-medium text-gray-700; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div id="loading-spinner" class="text-center">
             <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-gray-600">กำลังเชื่อมต่อ...</p>
        </div>
         <div id="auth-error" class="hidden text-center p-4">
             <p class="text-lg font-semibold text-red-600">การเชื่อมต่อล้มเหลว</p>
             <p class="text-sm text-gray-500 mt-2">กรุณาตรวจสอบการตั้งค่า Firebase และการเชื่อมต่ออินเทอร์เน็ต</p>
             <div id="auth-error-message" class="text-xs text-left bg-gray-100 p-2 rounded-md block mt-1 max-w-lg mx-auto"></div>
        </div>
    </div>

    <div class="container mx-auto max-w-4xl p-4">
        <header class="bg-white/70 backdrop-blur-sm rounded-xl shadow-md p-6 mb-6 text-center">
            <h1 class="text-4xl font-bold text-gray-700">Home Sweet Home</h1>
            <p id="app-status" class="text-xs text-gray-500 mt-2 break-all"></p>
        </header>

        <div class="mb-6">
            <div class="border-b border-gray-200 bg-white rounded-t-lg shadow-sm">
                <nav class="tabs-container -mb-px flex space-x-2 overflow-x-auto p-2" aria-label="Tabs">
                    <button onclick="window.App.changeTab('activity')" class="tab tab-active shrink-0 py-3 px-4 border-b-2 font-medium text-sm rounded-md">ภาพรวม</button>
                    <button onclick="window.App.changeTab('summary')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">สรุปค่าใช้จ่าย</button>
                    <button onclick="window.App.changeTab('builtin')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">Built-in</button>
                    <button onclick="window.App.changeTab('appliances')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">เครื่องใช้ไฟฟ้า</button>
                    <button onclick="window.App.changeTab('furniture')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">เฟอร์นิเจอร์</button>
                    <button onclick="window.App.changeTab('projectLegalities')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">นิติกรรมโครงการ</button>
                    <button onclick="window.App.changeTab('bankLegalities')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">นิติกรรมธนาคาร</button>
                    <button onclick="window.App.changeTab('homeInspection')" class="tab shrink-0 py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-md">ตรวจรับบ้าน</button>
                </nav>
            </div>
        </div>
        <main id="mainContent"></main>
    </div>

    <!-- MODALS -->
    <div id="appointmentModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0"></div>
    <div id="budgetItemModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0"></div>
    <div id="inspectionModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0"></div>
    <div id="noteModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0"></div>
    
    <script>
      // The content of the modals is added here for completeness
      document.getElementById('appointmentModal').innerHTML = `<div class="modal-content bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/3 transform -translate-y-10"><h3 class="text-xl font-semibold mb-4">เพิ่ม/แก้ไข นัดหมาย</h3> <form id="appointmentForm" class="space-y-4"> <input type="hidden" id="appointmentId"> <div> <label for="appointmentTitle" class="form-label">รายการนัดหมาย</label> <input id="appointmentTitle" type="text" class="form-input" placeholder="เช่น นัดตรวจบ้านรอบ 2" required> </div> <div class="grid grid-cols-2 gap-4"> <div> <label for="appointmentDate" class="form-label">วันที่</label> <input id="appointmentDate" type="date" class="form-input" required> </div> <div> <label for="appointmentTime" class="form-label">เวลา</label> <input id="appointmentTime" type="time" class="form-input" required> </div> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" onclick="window.App.closeModal('appointmentModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ยกเลิก</button> <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">บันทึก</button> </div> </form></div>`;
      document.getElementById('budgetItemModal').innerHTML = `<div class="modal-content bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/3 transform -translate-y-10"><h3 id="budgetItemModalTitle" class="text-xl font-semibold mb-4">เพิ่มรายการ</h3> <form id="budgetItemForm" class="space-y-4"> <input type="hidden" id="budgetItemId"> <div> <label for="budgetItemName" class="form-label">ชื่อรายการ</label> <input id="budgetItemName" type="text" class="form-input" placeholder="เช่น โซฟา" required> </div> <div> <label for="budgetItemCost" class="form-label">ราคา (บาท)</label> <input id="budgetItemCost" type="number" step="0.01" class="form-input" placeholder="25000" required> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" onclick="window.App.closeModal('budgetItemModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ยกเลิก</button> <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">บันทึก</button> </div> </form></div>`;
      document.getElementById('inspectionModal').innerHTML = `<div class="modal-content bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/2 transform -translate-y-10"><h3 class="text-xl font-semibold mb-4">เพิ่มรายการตรวจรับบ้าน</h3> <form id="inspectionForm" class="space-y-4"> <div> <label for="inspectionRound" class="form-label">การตรวจครั้งที่</label> <input id="inspectionRound" type="text" class="form-input" placeholder="เช่น 1, 2, แก้ไขครั้งที่ 1" required> </div> <div> <label for="inspectionDetails" class="form-label">รายการที่ต้องแก้ไข (1 รายการ/บรรทัด)</label> <textarea id="inspectionDetails" rows="8" class="form-input" placeholder="- สีผนังไม่เรียบ"></textarea> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" onclick="window.App.closeModal('inspectionModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ยกเลิก</button> <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">บันทึก</button> </div> </form></div>`;
      document.getElementById('noteModal').innerHTML = `<div class="modal-content bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/3 transform -translate-y-10"><h3 class="text-xl font-semibold mb-4">เพิ่ม/แก้ไข ข้อมูล</h3> <form id="noteForm" class="space-y-4"> <input type="hidden" id="noteId"> <div> <label for="noteText" class="form-label">รายละเอียด</label> <textarea id="noteText" rows="6" class="form-input" placeholder="บันทึกข้อมูลเพิ่มเติม..."></textarea> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" onclick="window.App.closeModal('noteModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ยกเลิก</button> <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">บันทึก</button> </div> </form></div>`;
    </script>
    
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ===================================================================================
        // Firebase Configuration - YOUR KEY IS NOW INCLUDED
        // ===================================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyBvpVOneaHb8pZUAYrHI6D3PLpURMEW-IQ",
          authDomain: "home-sweet-home-7afb2.firebaseapp.com",
          projectId: "home-sweet-home-7afb2",
          storageBucket: "home-sweet-home-7afb2.appspot.com",
          messagingSenderId: "716595539819",
          appId: "1:716595539819:web:770ae623d1d80ed26f262e"
        };
        // ===================================================================================

        const debounce = (func, delay) => { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; };

        const App = {
            state: {}, currentTab: 'activity', currentModal: {}, chartInstances: {},
            dataRef: null, unsubscribe: null, loadingTimeout: null,

            elements: { loadingOverlay: document.getElementById('loading-overlay'), loadingSpinner: document.getElementById('loading-spinner'), authErrorDiv: document.getElementById('auth-error'), authErrorMessage: document.getElementById('auth-error-message'), appStatus: document.getElementById('app-status'), mainContent: document.getElementById('mainContent'), },
            TAB_CONFIG: { 'activity': { title: 'ภาพรวม', type: 'activity' }, 'summary': { title: 'สรุปค่าใช้จ่าย', type: 'summary' }, 'builtin': { title: 'Built-in', type: 'budget' }, 'appliances': { title: 'เครื่องใช้ไฟฟ้า', type: 'budget' }, 'furniture': { title: 'เฟอร์นิเจอร์', type: 'budget' }, 'projectLegalities': { title: 'นิติกรรมโครงการ', type: 'project' }, 'bankLegalities': { title: 'นิติกรรมธนาคาร', type: 'bank' }, 'homeInspection': { title: 'ตรวจรับบ้าน', type: 'inspection' }, },
            getInitialData: () => ({ appointments: [], bankInfo: { loanHouse: 0, loanDecor: 0, interest1: 0, interest2: 0, interest3: 0, interest4: 0, withInsurance: 0, monthlyPayment: 0 }, projectInfo: { commonFee: 0 }, summaryInfo: { additionalBudget: 0 }, homeInspections: [], budgets: { builtin: { wishlist: [], purchased: [] }, appliances: { wishlist: [], purchased: [] }, furniture: { wishlist: [], purchased: [] }, }, notes: { builtin: [], appliances: [], furniture: [], projectLegalities: [], bankLegalities: [], homeInspection: [] } }),

            saveState: debounce(async function() { if (this.dataRef) { try { await setDoc(this.dataRef, this.state, { merge: true }); } catch (error) { console.error("Error saving state:", error); } } }, 1000),
            formatCurrency: (num) => (num || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
            getThaiDate: (dateString) => new Date(dateString).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }),
            
            render: function() { if (!this.state || typeof this.state.budgets === 'undefined') return; const tabId = this.currentTab; const config = this.TAB_CONFIG[tabId]; let content = ''; Object.values(this.chartInstances).forEach(chart => chart.destroy()); this.chartInstances = {}; switch(config.type) { case 'activity': content = this.createActivityTemplate(); break; case 'summary': content = this.createSummaryTemplate(); break; case 'budget': content = this.createBudgetTemplate(tabId); break; case 'project': content = this.createProjectLegalitiesTemplate(); break; case 'bank': content = this.createBankLegalitiesTemplate(); break; case 'inspection': content = this.createHomeInspectionTemplate(); break; } this.elements.mainContent.innerHTML = content; if (config.type === 'activity') this.createCharts('activityChartPlanned', 'activityChartActual'); if (config.type === 'summary') this.createCharts('summaryChartPlanned', 'summaryChartActual'); },
            changeTab: function(tabId) { document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('tab-active')); document.querySelector(`button[onclick="window.App.changeTab('${tabId}')"]`).classList.add('tab-active'); this.currentTab = tabId; this.render(); },
            updateAndSave: function(updateFn) { updateFn(); this.saveState(); this.render(); },
            
            init: function() {
                ['appointmentForm', 'budgetItemForm', 'inspectionForm', 'noteForm'].forEach(id => document.getElementById(id).addEventListener('submit', e => this.handleFormSubmit(e, id)));
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("...")) { this.showError("Firebase configuration is invalid."); return; }
                
                this.loadingTimeout = setTimeout(() => {
                    this.showError("การเชื่อมต่อหมดเวลา (Timeout). กรุณาตรวจสอบ Firestore Rules.");
                }, 15000);

                try {
                    const app = initializeApp(firebaseConfig);
                    const db = getFirestore(app);
                    this.setupFirestoreListener(db);
                } catch (e) { this.showError(`Firebase initialization failed: ${e.message}`); }
            },

            showError: function(message, isHtml = false) {
                clearTimeout(this.loadingTimeout);
                if (isHtml) { this.elements.authErrorMessage.innerHTML = message; } 
                else { this.elements.authErrorMessage.textContent = message; }
                this.elements.loadingSpinner.style.display = 'none';
                this.elements.authErrorDiv.classList.remove('hidden');
            },
            
            setupFirestoreListener: function(db) {
                clearTimeout(this.loadingTimeout);
                if (this.unsubscribe) this.unsubscribe();
                
                // Simplified path, identical to OPEX app logic
                this.dataRef = doc(db, "homeData", "sharedDocument");

                this.unsubscribe = onSnapshot(this.dataRef, (doc) => {
                    this.elements.appStatus.innerText = `ออนไลน์ - ข้อมูลซิงค์อัตโนมัติ`;
                    this.state = doc.exists() ? doc.data() : this.getInitialData();
                    const initialKeys = Object.keys(this.getInitialData());
                    for (const key of initialKeys) { if (typeof this.state[key] === 'undefined') this.state[key] = this.getInitialData()[key]; }
                    this.elements.loadingOverlay.style.display = 'none';
                    if(!doc.exists()) this.saveState();
                    this.render();
                }, (error) => { 
                     const projectId = firebaseConfig.projectId;
                     const rulesUrl = `https://console.firebase.google.com/project/${projectId}/firestore/rules`;
                     const guide = `
                        <div class='text-left text-sm p-2'>
                             <p class='font-bold'>ขั้นตอนสุดท้าย: ตั้งค่า Firestore Rules</p>
                             <ol class='list-decimal list-inside mt-2 space-y-1'>
                                 <li><a href="${rulesUrl}" target="_blank" class="text-blue-600 font-bold hover:underline">คลิกที่นี่</a> เพื่อไปที่หน้าตั้งค่า Rules</li>
                                 <li>ลบโค้ดเก่าทิ้งทั้งหมด แล้ววางโค้ดข้างล่างนี้แทน:</li>
                                 <li class='mt-1'><code class='bg-gray-200 p-1 rounded text-xs'>rules_version = '2';<br>service cloud.firestore {<br>  match /databases/{database}/documents {<br>    match /{document=**} {<br>      allow read, write: if true;<br>    }<br>  }<br>}</code></li>
                                 <li class='mt-1'>คลิก 'Publish' แล้วรีเฟรชหน้านี้</li>
                             </ol>
                         </div>
                     `;
                    this.showError(guide, true);
                });
            },

            handleFormSubmit: function(e, formId) {
                e.preventDefault();
                switch(formId) {
                    case 'appointmentForm': this.handleAppointmentSubmit(); break;
                    case 'budgetItemForm': this.handleBudgetItemSubmit(); break;
                    case 'inspectionForm': this.handleInspectionSubmit(); break;
                    case 'noteForm': this.handleNoteSubmit(); break;
                }
            },

            createActivityTemplate: function() { const sortedAppointments = [...(this.state.appointments || [])].sort((a,b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`)).filter(a => new Date(a.date) >= new Date(new Date().setDate(new Date().getDate() - 1))); const appointmentsHtml = sortedAppointments.length === 0 ? `<p class="text-center text-gray-500 py-4">ไม่มีนัดหมายเร็วๆ นี้</p>` : sortedAppointments.map(appt => `<div class="bg-gray-50 rounded-lg p-3 flex items-center space-x-4"><div class="flex-shrink-0 bg-blue-500 text-white rounded-md p-2 text-center w-16"><p class="text-xl font-bold">${new Date(appt.date).getDate()}</p><p class="text-xs">${new Date(appt.date).toLocaleDateString('th-TH', { month: 'short' })}</p></div><div><p class="font-semibold">${appt.title}</p><p class="text-sm text-gray-600">${this.getThaiDate(appt.date)} - ${appt.time}</p><p class="text-xs text-gray-400">จาก: ${this.TAB_CONFIG[appt.sourceTab]?.title}</p></div></div>`).join(''); return `<div class="space-y-6"><div class="bg-white rounded-xl shadow-md p-6"><h2 class="text-2xl font-semibold mb-4">นัดหมายที่จะถึง</h2><div class="space-y-3">${appointmentsHtml}</div></div><div class="bg-white rounded-xl shadow-md p-6"><h2 class="text-2xl font-semibold mb-4">ภาพรวมค่าใช้จ่าย</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center"><div><canvas id="activityChartPlanned"></canvas></div><div><canvas id="activityChartActual"></canvas></div></div></div></div>`; },
            calculateBudgets: function() { const result = { planned: {}, actual: {}, totalPlanned: 0, totalActual: 0, totalAvailable: (this.state.bankInfo?.loanDecor || 0) + (this.state.summaryInfo?.additionalBudget || 0), }; for (const cat in (this.state.budgets || {})) { result.planned[cat] = (this.state.budgets[cat].wishlist || []).reduce((sum, item) => sum + item.price, 0); result.actual[cat] = (this.state.budgets[cat].purchased || []).reduce((sum, item) => sum + item.price, 0); result.totalPlanned += result.planned[cat]; result.totalActual += result.actual[cat]; } return result; },
            createSummaryTemplate: function() { const budgetData = this.calculateBudgets(); return `<div class="bg-white rounded-xl shadow-md p-6 space-y-8"><div><h2 class="text-2xl font-semibold mb-4">สรุปงบประมาณ</h2><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div class="bg-green-50 p-4 rounded-lg"><p class="form-label">งบเงินกู้ (ตกแต่ง)</p><p class="text-2xl font-bold text-green-700">${this.formatCurrency(this.state.bankInfo.loanDecor)}</p></div><div class="bg-green-50 p-4 rounded-lg"><label for="additionalBudget" class="form-label">งบเพิ่มเติม</label><input type="number" id="additionalBudget" onchange="window.App.updateSummaryInfo('additionalBudget', this.value)" class="form-input text-2xl font-bold text-green-700 bg-transparent border-0 p-0" value="${this.state.summaryInfo.additionalBudget || ''}" placeholder="0.00"></div><div class="bg-blue-100 p-4 rounded-lg"><p class="form-label">งบประมาณทั้งหมด</p><p class="text-2xl font-bold text-blue-700">${this.formatCurrency(budgetData.totalAvailable)}</p></div></div></div><hr/><div><h2 class="text-2xl font-semibold mb-4">สรุปค่าใช้จ่าย</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="space-y-3"><h3 class="text-lg font-semibold">งบที่คาดว่าจะใช้ (Wishlist)</h3><div class="bg-orange-50 p-4 rounded-lg flex justify-between items-center"><span class="font-bold">รวมทั้งหมด</span><span class="text-xl font-bold text-orange-700">${this.formatCurrency(budgetData.totalPlanned)}</span></div>${Object.keys(this.state.budgets).map(cat => `<div class="p-3 rounded-lg flex justify-between items-center bg-gray-50"><span>${this.TAB_CONFIG[cat].title}</span><span class="font-semibold">${this.formatCurrency(budgetData.planned[cat])}</span></div>`).join('')}</div><div class="space-y-3"><h3 class="text-lg font-semibold">งบที่ใช้ไปแล้ว (Purchased)</h3><div class="bg-red-50 p-4 rounded-lg flex justify-between items-center"><span class="font-bold">รวมทั้งหมด</span><span class="text-xl font-bold text-red-700">${this.formatCurrency(budgetData.totalActual)}</span></div>${Object.keys(this.state.budgets).map(cat => `<div class="p-3 rounded-lg flex justify-between items-center bg-gray-50"><span>${this.TAB_CONFIG[cat].title}</span><span class="font-semibold">${this.formatCurrency(budgetData.actual[cat])}</span></div>`).join('')}</div></div></div><hr/><div><h2 class="text-2xl font-semibold mb-4">กราฟสรุป</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center"><div><canvas id="summaryChartPlanned"></canvas></div><div><canvas id="summaryChartActual"></canvas></div></div></div></div>`; },
            createBudgetTemplate: function(category) { const data = this.state.budgets[category]; const renderList = (listType, items) => { if (!items || items.length === 0) return `<div class="text-center text-gray-500 py-4 border rounded-lg">ไม่มีรายการ</div>`; return items.map(item => `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><div><p>${item.name}</p><p class="text-sm text-gray-600">${this.formatCurrency(item.price)} บาท</p></div><div class="flex items-center space-x-2">${listType === 'wishlist' ? `<button onclick="window.App.moveBudgetItem('${category}', '${item.id}')" class="text-green-500 hover:text-green-700 p-2"><i class="fas fa-check"></i></button>` : ''}<button onclick="window.App.openBudgetItemModal('${category}', '${listType}', '${item.id}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pen"></i></button><button onclick="window.App.deleteBudgetItem('${category}', '${listType}', '${item.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button></div></div>`).join(''); }; return `<div class="bg-white rounded-xl shadow-md p-6 space-y-6"><div><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">รายการที่อยากได้ (Wishlist)</h3><button onclick="window.App.openBudgetItemModal('${category}', 'wishlist')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm font-semibold">+ เพิ่ม</button></div><div class="space-y-2">${renderList('wishlist', data.wishlist)}</div></div><hr/><div><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">รายการที่ซื้อแล้ว</h3><button onclick="window.App.openBudgetItemModal('${category}', 'purchased')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm font-semibold">+ เพิ่ม</button></div><div class="space-y-2">${renderList('purchased', data.purchased)}</div></div></div>`; },
            createInfoTemplate: function(tabId) { const appointments = (this.state.appointments || []).filter(a => a.sourceTab === tabId); const appointmentsHtml = appointments.length === 0 ? `<p class="text-gray-500 text-sm">ไม่มีนัดหมาย</p>` : appointments.map(a => `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><div><p class="font-semibold">${a.title}</p><p class="text-sm text-gray-600">${this.getThaiDate(a.date)} - ${a.time}</p></div><div class="flex items-center space-x-2"><button onclick="window.App.openAppointmentModal('${tabId}', '${a.id}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pen"></i></button><button onclick="window.App.deleteAppointment('${a.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button></div></div>`).join(''); const notes = this.state.notes[tabId] || []; const notesHtml = notes.length === 0 ? `<p class="text-gray-500 text-sm">ไม่มีข้อมูลเพิ่มเติม</p>` : notes.map(n => `<div class="flex justify-between items-start p-3 bg-gray-50 rounded-lg"><p class="text-gray-700 whitespace-pre-wrap flex-1">${n.text}</p><div class="flex items-center space-x-2 ml-2"><button onclick="window.App.openNoteModal('${tabId}', '${n.id}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pen"></i></button><button onclick="window.App.deleteNote('${tabId}', '${n.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button></div></div>`).join(''); return { appointmentsHtml, notesHtml }; },
            createActionButtonsTemplate: function(tabId) { return `<div class="flex flex-wrap gap-4"><button onclick="window.App.openAppointmentModal('${tabId}')" class="flex-grow sm:flex-grow-0 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center space-x-2"><i class="fas fa-calendar-plus"></i> <span>เพิ่มนัดหมาย</span></button><button onclick="window.App.openNoteModal('${tabId}')" class="flex-grow sm:flex-grow-0 bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 flex items-center justify-center space-x-2"><i class="fas fa-file-alt"></i> <span>เพิ่มข้อมูล</span></button></div>`; },
            createProjectLegalitiesTemplate: function() { const { commonFee } = this.state.projectInfo; const { appointmentsHtml, notesHtml } = this.createInfoTemplate('projectLegalities'); return `<div class="bg-white rounded-xl shadow-md p-6 space-y-6"><div><h2 class="text-2xl font-semibold mb-4">ข้อมูลนิติกรรมโครงการ</h2><div class="max-w-sm"><label for="commonFee" class="form-label">ค่าส่วนกลาง (บาท/เดือน)</label><input type="number" id="commonFee" class="form-input" value="${commonFee || ''}" onchange="window.App.updateProjectInfo('commonFee', this.value)" placeholder="2000"></div></div><hr/><div><h3 class="text-xl font-semibold mb-3">นัดหมาย</h3><div class="space-y-2">${appointmentsHtml}</div></div><hr/><div><h3 class="text-xl font-semibold mb-3">ข้อมูลเพิ่มเติม</h3><div class="space-y-2">${notesHtml}</div></div><hr/>${this.createActionButtonsTemplate('projectLegalities')}</div>`; },
            createBankLegalitiesTemplate: function() { const { loanHouse, loanDecor, interest1, interest2, interest3, interest4, withInsurance, monthlyPayment } = this.state.bankInfo; const { appointmentsHtml, notesHtml } = this.createInfoTemplate('bankLegalities'); return `<div class="bg-white rounded-xl shadow-md p-6 space-y-6"><div><h2 class="text-2xl font-semibold mb-4">ข้อมูลสินเชื่อ</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="loanHouse" class="form-label">วงเงินกู้ (ค่าบ้าน)</label><input type="number" id="loanHouse" onchange="window.App.updateBankInfo('loanHouse', this.value)" value="${loanHouse || ''}" class="form-input" placeholder="3000000"></div><div><label for="loanDecor" class="form-label">วงเงินกู้ (ตกแต่ง)</label><input type="number" id="loanDecor" onchange="window.App.updateBankInfo('loanDecor', this.value)" value="${loanDecor || ''}" class="form-input" placeholder="500000"></div><div><label for="interest1" class="form-label">ดอกเบี้ยปีที่ 1 (%)</label><input type="number" step="0.01" id="interest1" onchange="window.App.updateBankInfo('interest1', this.value)" value="${interest1 || ''}" class="form-input" placeholder="2.5"></div><div><label for="interest2" class="form-label">ดอกเบี้ยปีที่ 2 (%)</label><input type="number" step="0.01" id="interest2" onchange="window.App.updateBankInfo('interest2', this.value)" value="${interest2 || ''}" class="form-input" placeholder="3.5"></div><div><label for="interest3" class="form-label">ดอกเบี้ยปีที่ 3 (%)</label><input type="number" step="0.01" id="interest3" onchange="window.App.updateBankInfo('interest3', this.value)" value="${interest3 || ''}" class="form-input" placeholder="4.5"></div><div><label for="interest4" class="form-label">ดอกเบี้ยปีที่ 4+ (%)</label><input type="number" step="0.01" id="interest4" onchange="window.App.updateBankInfo('interest4', this.value)" value="${interest4 || ''}" class="form-input" placeholder="5.5"></div><div><label for="withInsurance" class="form-label">วงเงินรวมประกัน</label><input type="number" id="withInsurance" onchange="window.App.updateBankInfo('withInsurance', this.value)" value="${withInsurance || ''}" class="form-input" placeholder="3600000"></div><div><label for="monthlyPayment" class="form-label">ยอดผ่อน/เดือน</label><input type="number" id="monthlyPayment" onchange="window.App.updateBankInfo('monthlyPayment', this.value)" value="${monthlyPayment || ''}" class="form-input" placeholder="18000"></div></div></div><hr/><div><h3 class="text-xl font-semibold mb-3">นัดหมาย</h3><div class="space-y-2">${appointmentsHtml}</div></div><hr/><div><h3 class="text-xl font-semibold mb-3">ข้อมูลเพิ่มเติม</h3><div class="space-y-2">${notesHtml}</div></div><hr/>${this.createActionButtonsTemplate('bankLegalities')}</div>`; },
            createHomeInspectionTemplate: function() { const inspectionsHtml = (this.state.homeInspections || []).length === 0 ? `<p class="text-center text-gray-500 py-4">ยังไม่มีรายการตรวจ</p>` : this.state.homeInspections.map(insp => `<div class="bg-gray-50 rounded-lg p-4"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-lg">การตรวจครั้งที่ ${insp.round}</h4><button onclick="window.App.deleteInspection('${insp.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button></div><ul class="list-disc pl-5 space-y-1 text-gray-700 whitespace-pre-wrap">${insp.details.split('\n').filter(line => line.trim() !== '').map(line => `<li>${line}</li>`).join('')}</ul></div>`).join(''); const { appointmentsHtml, notesHtml } = this.createInfoTemplate('homeInspection'); return `<div class="bg-white rounded-xl shadow-md p-6 space-y-6"><div><h2 class="text-2xl font-semibold">รายการตรวจรับบ้าน</h2></div><div class="space-y-4">${inspectionsHtml}</div><hr/><div><h3 class="text-xl font-semibold mb-3">นัดหมาย</h3><div class="space-y-2">${appointmentsHtml}</div></div><hr/><div><h3 class="text-xl font-semibold mb-3">ข้อมูลเพิ่มเติม</h3><div class="space-y-2">${notesHtml}</div></div><hr/><div class="flex flex-wrap gap-4"><button onclick="window.App.openInspectionModal()" class="flex-grow sm:flex-grow-0 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center justify-center space-x-2"><i class="fas fa-plus"></i> <span>เพิ่มรายการตรวจ</span></button>${this.createActionButtonsTemplate('homeInspection').replace('<div class="flex flex-wrap gap-4">','').replace('</div>','')}</div></div>`; },
            createCharts: function(plannedCanvasId, actualCanvasId) { const budgetData = this.calculateBudgets(); const categories = Object.keys(this.state.budgets || {}); const labels = categories.map(c => this.TAB_CONFIG[c].title); const colors = ['#34d399', '#fbbf24', '#60a5fa']; const plannedRemaining = Math.max(0, budgetData.totalAvailable - budgetData.totalPlanned); const actualRemaining = Math.max(0, budgetData.totalAvailable - budgetData.totalActual); const plannedCtx = document.getElementById(plannedCanvasId)?.getContext('2d'); if(plannedCtx) { this.chartInstances.planned = new Chart(plannedCtx, { type: 'doughnut', data: { labels: [...labels, 'งบประมาณคงเหลือ'], datasets: [{ data: [...categories.map(c => budgetData.planned[c]), plannedRemaining], backgroundColor: [...colors, '#e5e7eb'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: `งบที่คาดว่าจะใช้ (รวม ${this.formatCurrency(budgetData.totalPlanned)})` } } } }); } const actualCtx = document.getElementById(actualCanvasId)?.getContext('2d'); if(actualCtx) { this.chartInstances.actual = new Chart(actualCtx, { type: 'doughnut', data: { labels: [...labels, 'งบประมาณคงเหลือ'], datasets: [{ data: [...categories.map(c => budgetData.actual[c]), actualRemaining], backgroundColor: [...colors, '#e5e7eb'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: `งบที่ใช้ไปแล้ว (รวม ${this.formatCurrency(budgetData.totalActual)})` } } } }); } },
            updateSummaryInfo: function(key, value) { this.updateAndSave(() => this.state.summaryInfo[key] = parseFloat(value) || 0); },
            updateProjectInfo: function(key, value) { this.updateAndSave(() => this.state.projectInfo[key] = parseFloat(value) || 0); },
            updateBankInfo: function(key, value) { this.updateAndSave(() => this.state.bankInfo[key] = parseFloat(value) || 0); },
            openInspectionModal: function() { document.getElementById('inspectionForm').reset(); this.openModal('inspectionModal'); },
            handleInspectionSubmit: function() { this.updateAndSave(() => { if(!this.state.homeInspections) this.state.homeInspections = []; this.state.homeInspections.push({ id: `insp_${Date.now()}`, round: document.getElementById('inspectionRound').value, details: document.getElementById('inspectionDetails').value }); }); this.closeModal('inspectionModal'); },
            deleteInspection: function(id) { this.updateAndSave(() => this.state.homeInspections = this.state.homeInspections.filter(i => i.id !== id)); },
            openBudgetItemModal: function(category, list, itemId = null) { this.currentModal = { category, list, itemId }; const form = document.getElementById('budgetItemForm'); form.reset(); document.getElementById('budgetItemId').value = ''; document.getElementById('budgetItemModalTitle').innerText = `${itemId ? 'แก้ไข' : 'เพิ่ม'}รายการ: ${this.TAB_CONFIG[category].title}`; if(itemId) { const item = this.state.budgets[category][list].find(i => i.id === itemId); if(item) { document.getElementById('budgetItemId').value = item.id; document.getElementById('budgetItemName').value = item.name; document.getElementById('budgetItemCost').value = item.price; } } this.openModal('budgetItemModal'); },
            handleBudgetItemSubmit: function() { const { category, list } = this.currentModal; const id = document.getElementById('budgetItemId').value; const itemData = { name: document.getElementById('budgetItemName').value, price: parseFloat(document.getElementById('budgetItemCost').value) }; this.updateAndSave(() => { if(id) { const itemIndex = this.state.budgets[category][list].findIndex(i => i.id === id); if(itemIndex > -1) this.state.budgets[category][list][itemIndex] = { ...this.state.budgets[category][list][itemIndex], ...itemData }; } else { this.state.budgets[category][list].push({ id: `item_${Date.now()}`, ...itemData }); } }); this.closeModal('budgetItemModal'); },
            deleteBudgetItem: function(category, list, itemId) { this.updateAndSave(() => this.state.budgets[category][list] = this.state.budgets[category][list].filter(i => i.id !== itemId)); },
            moveBudgetItem: function(category, itemId) { this.updateAndSave(() => { const itemIndex = this.state.budgets[category].wishlist.findIndex(i => i.id === itemId); if(itemIndex > -1) { const [item] = this.state.budgets[category].wishlist.splice(itemIndex, 1); if(!this.state.budgets[category].purchased) this.state.budgets[category].purchased = []; this.state.budgets[category].purchased.push(item); } }); },
            openAppointmentModal: function(sourceTab, appointmentId = null) { this.currentModal = { sourceTab, itemId: appointmentId }; const form = document.getElementById('appointmentForm'); form.reset(); document.getElementById('appointmentId').value = ''; if (appointmentId) { const appt = this.state.appointments.find(a => a.id === appointmentId); if (appt) { document.getElementById('appointmentId').value = appt.id; document.getElementById('appointmentTitle').value = appt.title; document.getElementById('appointmentDate').value = appt.date; document.getElementById('appointmentTime').value = appt.time; } } this.openModal('appointmentModal'); },
            handleAppointmentSubmit: function() { const id = document.getElementById('appointmentId').value; const apptData = { title: document.getElementById('appointmentTitle').value, date: document.getElementById('appointmentDate').value, time: document.getElementById('appointmentTime').value, sourceTab: this.currentModal.sourceTab }; this.updateAndSave(() => { if(!this.state.appointments) this.state.appointments = []; if (id) { const apptIndex = this.state.appointments.findIndex(a => a.id === id); if (apptIndex > -1) this.state.appointments[apptIndex] = { ...this.state.appointments[apptIndex], ...apptData }; } else { this.state.appointments.push({ ...apptData, id: `appt_${Date.now()}` }); } }); this.closeModal('appointmentModal'); },
            deleteAppointment: function(id) { this.updateAndSave(() => this.state.appointments = this.state.appointments.filter(a => a.id !== id)); },
            openNoteModal: function(sourceTab, noteId = null) { this.currentModal = { sourceTab, itemId: noteId }; const form = document.getElementById('noteForm'); form.reset(); document.getElementById('noteId').value = ''; if (noteId) { const note = this.state.notes[sourceTab].find(n => n.id === noteId); if (note) { document.getElementById('noteId').value = note.id; document.getElementById('noteText').value = note.text; } } this.openModal('noteModal'); },
            handleNoteSubmit: function() { const id = document.getElementById('noteId').value; const { sourceTab } = this.currentModal; const noteData = { text: document.getElementById('noteText').value }; this.updateAndSave(() => { if(!this.state.notes[sourceTab]) this.state.notes[sourceTab] = []; if (id) { const noteIndex = this.state.notes[sourceTab].findIndex(n => n.id === id); if (noteIndex > -1) this.state.notes[sourceTab][noteIndex] = { ...this.state.notes[sourceTab][noteIndex], ...noteData }; } else { this.state.notes[sourceTab].push({ ...noteData, id: `note_${Date.now()}` }); } }); this.closeModal('noteModal'); },
            deleteNote: function(sourceTab, noteId) { this.updateAndSave(() => this.state.notes[sourceTab] = this.state.notes[sourceTab].filter(n => n.id !== noteId)); },
            openModal: function(modalId) { const modal = document.getElementById(modalId); modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('-translate-y-10'); }, 10); },
            closeModal: function(modalId) { const modal = document.getElementById(modalId); modal.classList.add('opacity-0'); modal.querySelector('.modal-content').classList.add('-translate-y-10'); setTimeout(() => { modal.classList.add('hidden'); this.currentModal = {}; }, 250); },
        };
        
        // --- KICKSTART APP ---
        window.App = App;
        document.addEventListener('DOMContentLoaded', () => App.init());
        
    </script>
</body>
</html>

